---
title: "Demographics of Adult Heritage Language Speakers in the United States"
author: "Tomonori Nagano"
date: "2015-12-31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Overview

This notebook reproduces the heritage language demographic tables from:

Nagano, T. (2015). *Demographics of Adult Heritage Language Speakers in the United States: Differences by Region and Language and their Implications*. The Modern Language Journal, 99(4), 771-792.

# Data

Download the U.S. Census/ACS data from <https://usa.ipums.org/> (IPUMS USA).
The analysis expects SPSS `.sav` files named:

```
DATA_DOWNLOADED_FROM_IPUMS_SAMPLE1980.sav
DATA_DOWNLOADED_FROM_IPUMS_SAMPLE1990.sav
DATA_DOWNLOADED_FROM_IPUMS_SAMPLE2000.sav
DATA_DOWNLOADED_FROM_IPUMS_SAMPLE2010.sav
DATA_DOWNLOADED_FROM_IPUMS_SAMPLE2020.sav
```

You can keep the zipped versions (`.sav.zip`) in `data/`; the script will unzip to a temporary directory when needed.

# Setup

```{r}
file_years <- c(1980, 1990, 2000, 2010, 2020)
data_dir <- "data"
output_dir <- "ROutput"
```

# Derived variables

- Heritage language (HL) speakers are defined as adults (age > 18) who speak a non-English language at home, are not "Does not speak English," and did not immigrate after age 18.
- Ethnicity uses `HISPAN`; race uses `RACESING`.
- Education uses `EDUC`.
- Income uses `FTOTINC` and is binned as: Negative, 0-9,999, 10,000-24,999, 25,000-49,999, 50,000-74,999, 75,000-99,999, 100,000+.
- Age bins are: 0-17, 18-24, 25-34, 35-44, 45-54, 55-64, 65+.
- Immigration generation uses `BPL` plus parent nativity based on `MOMLOC`/`POPLOC`:
  - First generation: foreign-born.
  - Second generation: U.S.-born with at least one foreign-born parent.
  - Third+ generation: U.S.-born with U.S.-born parents.
  - Unknown: parent information missing in the household.

```{r analysis-functions, echo=TRUE}
# Improved analysis workflow for IPUMS heritage language demographics.

suppressPackageStartupMessages({
  if (!requireNamespace("foreign", quietly = TRUE)) {
    stop("Package 'foreign' is required. Install with install.packages('foreign').")
  }
})

parse_numeric_factor <- function(x) {
  if (is.numeric(x)) {
    return(x)
  }
  suppressWarnings(as.numeric(as.character(x)))
}

parse_year_from_label <- function(x) {
  year <- suppressWarnings(as.numeric(x))
  if (!is.na(year)) {
    return(year)
  }
  match <- regexpr("[0-9]{4}", x)
  if (match > 0) {
    return(as.numeric(substr(x, match, match + 3)))
  }
  NA_real_
}

safe_xtabs <- function(formula, data, vars) {
  if (!all(vars %in% names(data))) {
    return(NULL)
  }
  xtabs(formula, data = data)
}

print_snippet <- function(x, max_rows = 6, max_cols = 8) {
  if (is.null(x)) {
    return(invisible(NULL))
  }
  if (is.vector(x) || is.table(x)) {
    x <- as.matrix(x)
  }
  if (is.matrix(x) || is.data.frame(x)) {
    row_idx <- seq_len(min(nrow(x), max_rows))
    col_idx <- seq_len(min(ncol(x), max_cols))
    print(x[row_idx, col_idx, drop = FALSE])
    return(invisible(NULL))
  }
  print(utils::head(x, max_rows))
  invisible(NULL)
}

hl_comparison_table <- function(df, category_var, hl_conditions) {
  if (!category_var %in% names(df)) {
    return(NULL)
  }
  category <- df[[category_var]]
  hl_flag <- ifelse(hl_conditions, "HL", "Non-HL")
  counts <- xtabs(df$PERWT ~ category + hl_flag)
  counts_df <- as.data.frame.matrix(counts)

  total_by_category <- rowSums(counts_df, na.rm = TRUE)
  counts_df$HL_Prop <- ifelse(total_by_category > 0, counts_df$HL / total_by_category, NA_real_)
  counts_df$NonHL_Prop <- ifelse(total_by_category > 0, counts_df$`Non-HL` / total_by_category, NA_real_)

  counts_df
}

read_ipums_spss <- function(file_year, data_dir) {
  file_year <- as.character(file_year)
  base_name <- paste0("DATA_DOWNLOADED_FROM_IPUMS_SAMPLE", file_year, ".sav")
  sav_path <- file.path(data_dir, base_name)

  if (!file.exists(sav_path)) {
    zip_path <- file.path(data_dir, paste0(base_name, ".zip"))
    if (!file.exists(zip_path)) {
      stop("Missing input file: ", sav_path, " (or zipped .sav.zip).")
    }
    tmp_dir <- tempfile("ipums_")
    dir.create(tmp_dir)
    unzip(zip_path, exdir = tmp_dir)
    sav_files <- list.files(tmp_dir, pattern = "\\.sav$", full.names = TRUE)
    if (length(sav_files) != 1) {
      stop("Expected one .sav file after unzip, found: ", length(sav_files))
    }
    sav_path <- sav_files[1]
  }

  data <- foreign::read.spss(sav_path, to.data.frame = TRUE, use.value.labels = TRUE)
  droplevels(data)
}

normalize_age <- function(age_factor) {
  age_num <- parse_numeric_factor(age_factor)
  age_num[is.na(age_num)] <- 0
  age_num
}

recode_yrimmig <- function(yrimmig, file_year) {
  file_year <- as.character(file_year)
  levels_map <- list(
    "1980" = c(NA, "1949", "1959", "1964", "1969", "1974", "1980"),
    "1990" = c(NA, "1949", "1959", "1964", "1969", "1974", "1979",
               "1981", "1984", "1986", "1990"),
    "2000" = c("N/A", "1910", "1914", "1919", "1920", "1921", "1922",
               "1923", "1924", "1925", "1926", "1927", "1928", "1929",
               "1930", "1935", "1936", "1937", "1938", "1939", "1940",
               "1941", "1942", "1943", "1944", "1945", "1946", "1947",
               "1948", "1949", "1950", "1951", "1952", "1953", "1954",
               "1955", "1956", "1957", "1958", "1959", "1960", "1961",
               "1962", "1963", "1964", "1965", "1966", "1967", "1968",
               "1969", "1970", "1971", "1972", "1973", "1974", "1975",
               "1976", "1977", "1978", "1979", "1980", "1981", "1982",
               "1983", "1984", "1985", "1986", "1987", "1988", "1989",
               "1990", "1991", "1992", "1993", "1994", "1995", "1996",
               "1997", "1998", "1999", "2000"),
    "2010" = c(NA, "1919", "1920", "1921", "1922", "1923", "1924", "1925",
               "1926", "1927", "1928", "1929", "1930", "1932", "1934",
               "1935", "1936", "1937", "1938", "1939", "1940", "1941",
               "1942", "1943", "1944", "1945", "1946", "1947", "1948",
               "1949", "1950", "1951", "1952", "1953", "1954", "1955",
               "1956", "1957", "1958", "1959", "1960", "1961", "1962",
               "1963", "1964", "1965", "1966", "1967", "1968", "1969",
               "1970", "1971", "1972", "1973", "1974", "1975", "1976",
               "1977", "1978", "1979", "1980", "1981", "1982", "1983",
               "1984", "1985", "1986", "1987", "1988", "1989", "1990",
               "1991", "1992", "1993", "1994", "1995", "1996", "1997",
               "1998", "1999", "2000", "2001", "2002", "2003", "2004",
               "2005", "2006", "2007", "2008", "2009", "2010")
  )

  new_levels <- levels_map[[file_year]]
  if (is.null(new_levels)) {
    labels <- as.character(yrimmig)
    return(vapply(labels, parse_year_from_label, numeric(1)))
  }
  if (length(levels(yrimmig)) != length(new_levels)) {
    warning("Unexpected YRIMMIG levels; using existing labels.")
    labels <- as.character(yrimmig)
    return(vapply(labels, parse_year_from_label, numeric(1)))
  }

  levels(yrimmig) <- new_levels
  suppressWarnings(as.numeric(as.character(yrimmig)))
}

bin_age <- function(age_num) {
  cut(
    age_num,
    breaks = c(-Inf, 17, 24, 34, 44, 54, 64, Inf),
    labels = c("0-17", "18-24", "25-34", "35-44", "45-54", "55-64", "65+"),
    right = TRUE
  )
}

bin_income <- function(income_num) {
  cut(
    income_num,
    breaks = c(-Inf, -1, 9999, 24999, 49999, 74999, 99999, Inf),
    labels = c(
      "Negative",
      "0-9,999",
      "10,000-24,999",
      "25,000-49,999",
      "50,000-74,999",
      "75,000-99,999",
      "100,000+"
    ),
    right = TRUE
  )
}

derive_parent_bpl <- function(df) {
  if (!all(c("SERIAL", "PERNUM", "MOMLOC", "POPLOC", "BPL") %in% names(df))) {
    return(list(
      mom_bpl = rep(NA, nrow(df)),
      pop_bpl = rep(NA, nrow(df))
    ))
  }

  key <- paste(df$SERIAL, df$PERNUM, sep = "_")
  bpl_map <- setNames(df$BPL, key)

  mom_key <- ifelse(!is.na(df$MOMLOC) & df$MOMLOC > 0,
                    paste(df$SERIAL, df$MOMLOC, sep = "_"),
                    NA)
  pop_key <- ifelse(!is.na(df$POPLOC) & df$POPLOC > 0,
                    paste(df$SERIAL, df$POPLOC, sep = "_"),
                    NA)

  mom_bpl <- unname(bpl_map[mom_key])
  pop_bpl <- unname(bpl_map[pop_key])

  list(mom_bpl = mom_bpl, pop_bpl = pop_bpl)
}

prepare_ipums_data <- function(df, file_year) {
  us_states <- c(
    "Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut",
    "Delaware","District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois",
    "Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts",
    "Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
    "New Hampshire","New Jersey","New Mexico","New York","North Carolina",
    "North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island",
    "South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia",
    "Washington","West Virginia","Wisconsin","Wyoming","American Samoa","Guam",
    "Puerto Rico"
  )

  df$USBorn <- df$BPL %in% us_states
  df$AGE_ORIG <- df$AGE
  df$AGE <- normalize_age(df$AGE)
  df$AGE_BIN <- bin_age(df$AGE)
  df$ADULT <- df$AGE > 18

  df$YRIMMIG_ORIG <- df$YRIMMIG
  yrimmig_years <- recode_yrimmig(df$YRIMMIG, file_year)
  df$YRIMMIG <- as.numeric(file_year) - yrimmig_years
  df$IMMIGADULT <- df$YRIMMIG > 18
  df$IMMIGADULT[is.na(df$IMMIGADULT)] <- FALSE

  df$SPEAKENGWell <- df$SPEAKENG %in% c("Yes, speaks very well", "Yes, speaks well")
  df$SPEAKNoENG <- df$SPEAKENG == "Does not speak English"
  df$SPEAKHL <- !(df$LANGUAGE %in% c("N/A or blank", "English"))

  if ("FTOTINC" %in% names(df)) {
    df$FTOTINC_NUM <- parse_numeric_factor(df$FTOTINC)
    df$INCOME_BIN <- bin_income(df$FTOTINC_NUM)
  } else {
    df$FTOTINC_NUM <- NA_real_
    df$INCOME_BIN <- NA
  }

  parent_bpl <- derive_parent_bpl(df)
  df$MOM_BPL <- parent_bpl$mom_bpl
  df$POP_BPL <- parent_bpl$pop_bpl
  df$PARENT_INFO_MISSING <- is.na(df$MOM_BPL) & is.na(df$POP_BPL)
  df$PARENT_FOREIGN_BORN <- (!is.na(df$MOM_BPL) & !(df$MOM_BPL %in% us_states)) |
    (!is.na(df$POP_BPL) & !(df$POP_BPL %in% us_states))

  df$IMMIG_GEN <- ifelse(
    !df$USBorn,
    "First generation",
    ifelse(
      df$PARENT_FOREIGN_BORN,
      "Second generation",
      ifelse(df$PARENT_INFO_MISSING, "Unknown", "Third+ generation")
    )
  )

  df
}

compute_hl_tables <- function(df) {
  hl_conditions <- df$ADULT & df$SPEAKHL & !df$SPEAKNoENG & !df$IMMIGADULT
  hl_order <- rev(order(colSums(xtabs(PERWT ~ STATEFIP + LANGUAGE, data = df[hl_conditions, ]))))

  list(
    hl_conditions = hl_conditions,
    hl_order = hl_order,
    adult_population = safe_xtabs(PERWT ~ STATEFIP, df, c("PERWT", "STATEFIP")),
    table_race = safe_xtabs(PERWT ~ RACESING, df, c("PERWT", "RACESING")),
    table_hispanic = safe_xtabs(PERWT ~ HISPAN, df, c("PERWT", "HISPAN")),
    table_all_hl_state = safe_xtabs(PERWT ~ STATEFIP + LANGUAGE, df[df$SPEAKHL, ],
                                    c("PERWT", "STATEFIP", "LANGUAGE")),
    table_hl_region = safe_xtabs(PERWT ~ REGION + LANGUAGE, df[hl_conditions, ],
                                 c("PERWT", "REGION", "LANGUAGE")),
    table_hl_state = safe_xtabs(PERWT ~ STATEFIP + LANGUAGE, df[hl_conditions, ],
                                c("PERWT", "STATEFIP", "LANGUAGE")),
    table_hl_conspuma = safe_xtabs(PERWT ~ CONSPUMA + LANGUAGE, df[hl_conditions, ],
                                   c("PERWT", "CONSPUMA", "LANGUAGE")),
    table_hl_metro = safe_xtabs(PERWT ~ METRO + LANGUAGE, df[hl_conditions, ],
                                c("PERWT", "METRO", "LANGUAGE")),
    table_hl_ethnicity = hl_comparison_table(df, "HISPAN", hl_conditions),
    table_hl_race = hl_comparison_table(df, "RACESING", hl_conditions),
    table_hl_education = hl_comparison_table(df, "EDUC", hl_conditions),
    table_hl_income = hl_comparison_table(df, "INCOME_BIN", hl_conditions),
    table_hl_age = hl_comparison_table(df, "AGE_BIN", hl_conditions),
    table_hl_immig_gen = hl_comparison_table(df, "IMMIG_GEN", hl_conditions)
  )
}

write_hl_outputs <- function(tables, file_year, output_dir, print_tables = FALSE) {
  dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
  file_year <- as.character(file_year)

  order_lang_cols <- function(tbl, hl_order) {
    if (is.null(dim(tbl))) {
      return(tbl)
    }
    tbl[, hl_order, drop = FALSE]
  }

  output_paths <- list(
    adult_states = file.path(output_dir, paste0("Output00_TableAdultStatesPopulation", file_year, ".csv")),
    race = file.path(output_dir, paste0("Output01_TableRace", file_year, ".csv")),
    hispanic = file.path(output_dir, paste0("Output02_TableRaceHispanic", file_year, ".csv")),
    all_hl_state = file.path(output_dir, paste0("Output03_TableAllHLSpeakersByState", file_year, ".csv")),
    hl_region = file.path(output_dir, paste0("Output04_TableHLSpeakersByRegion", file_year, ".csv")),
    hl_state = file.path(output_dir, paste0("Output05_TableHLSpeakersByState", file_year, ".csv")),
    hl_conspuma = file.path(output_dir, paste0("Output06_TableHLSpeakersByCONSPUMA", file_year, ".csv")),
    hl_metro = file.path(output_dir, paste0("Output07_TableHLSpeakersByMetro", file_year, ".csv")),
    hl_ethnicity = file.path(output_dir, paste0("Output08_TableHLSpeakersByEthnicity", file_year, ".csv")),
    hl_race = file.path(output_dir, paste0("Output09_TableHLSpeakersByRace", file_year, ".csv")),
    hl_education = file.path(output_dir, paste0("Output10_TableHLSpeakersByEducation", file_year, ".csv")),
    hl_income = file.path(output_dir, paste0("Output11_TableHLSpeakersByIncome", file_year, ".csv")),
    hl_age = file.path(output_dir, paste0("Output12_TableHLSpeakersByAge", file_year, ".csv")),
    hl_immig_gen = file.path(output_dir, paste0("Output13_TableHLSpeakersByImmigrationGeneration", file_year, ".csv"))
  )

  if (!is.null(tables$adult_population)) {
    if (print_tables) {
      print_snippet(tables$adult_population)
    }
    write.csv(tables$adult_population, file = output_paths$adult_states)
  }
  if (!is.null(tables$table_race)) {
    if (print_tables) {
      print_snippet(tables$table_race)
    }
    write.csv(tables$table_race, file = output_paths$race)
  }
  if (!is.null(tables$table_hispanic)) {
    if (print_tables) {
      print_snippet(tables$table_hispanic)
    }
    write.csv(tables$table_hispanic, file = output_paths$hispanic)
  }
  if (!is.null(tables$table_all_hl_state)) {
    if (print_tables) {
      print_snippet(order_lang_cols(tables$table_all_hl_state, tables$hl_order))
    }
    write.csv(order_lang_cols(tables$table_all_hl_state, tables$hl_order), file = output_paths$all_hl_state)
  }
  if (!is.null(tables$table_hl_region)) {
    if (print_tables) {
      print_snippet(order_lang_cols(tables$table_hl_region, tables$hl_order))
    }
    write.csv(order_lang_cols(tables$table_hl_region, tables$hl_order), file = output_paths$hl_region)
  }
  if (!is.null(tables$table_hl_state)) {
    if (print_tables) {
      print_snippet(order_lang_cols(tables$table_hl_state, tables$hl_order))
    }
    write.csv(order_lang_cols(tables$table_hl_state, tables$hl_order), file = output_paths$hl_state)
  }
  if (!is.null(tables$table_hl_conspuma)) {
    if (print_tables) {
      print_snippet(order_lang_cols(tables$table_hl_conspuma, tables$hl_order))
    }
    write.csv(order_lang_cols(tables$table_hl_conspuma, tables$hl_order), file = output_paths$hl_conspuma)
  }
  if (!is.null(tables$table_hl_metro)) {
    if (print_tables) {
      print_snippet(order_lang_cols(tables$table_hl_metro, tables$hl_order))
    }
    write.csv(order_lang_cols(tables$table_hl_metro, tables$hl_order), file = output_paths$hl_metro)
  }
  if (!is.null(tables$table_hl_ethnicity)) {
    if (print_tables) {
      print_snippet(tables$table_hl_ethnicity)
    }
    write.csv(tables$table_hl_ethnicity, file = output_paths$hl_ethnicity)
  }
  if (!is.null(tables$table_hl_race)) {
    if (print_tables) {
      print_snippet(tables$table_hl_race)
    }
    write.csv(tables$table_hl_race, file = output_paths$hl_race)
  }
  if (!is.null(tables$table_hl_education)) {
    if (print_tables) {
      print_snippet(tables$table_hl_education)
    }
    write.csv(tables$table_hl_education, file = output_paths$hl_education)
  }
  if (!is.null(tables$table_hl_income)) {
    if (print_tables) {
      print_snippet(tables$table_hl_income)
    }
    write.csv(tables$table_hl_income, file = output_paths$hl_income)
  }
  if (!is.null(tables$table_hl_age)) {
    if (print_tables) {
      print_snippet(tables$table_hl_age)
    }
    write.csv(tables$table_hl_age, file = output_paths$hl_age)
  }
  if (!is.null(tables$table_hl_immig_gen)) {
    if (print_tables) {
      print_snippet(tables$table_hl_immig_gen)
    }
    write.csv(tables$table_hl_immig_gen, file = output_paths$hl_immig_gen)
  }

  output_paths
}

run_analysis <- function(file_year, data_dir = "data", output_dir = "ROutput", print_tables = FALSE) {
  df <- read_ipums_spss(file_year, data_dir)
  df <- prepare_ipums_data(df, file_year)
  tables <- compute_hl_tables(df)
  output_paths <- write_hl_outputs(tables, file_year, output_dir, print_tables = print_tables)

  summary <- list(
    total_population = sum(df$PERWT),
    total_speak_hl = sum(df[df$SPEAKHL, "PERWT"]),
    total_hl = sum(df[tables$hl_conditions, "PERWT"]),
    share_foreign_born = sum(df[!df$USBorn, "PERWT"]) / sum(df$PERWT)
  )

  list(summary = summary, output_paths = output_paths, tables = tables)
}
```

# Run the analysis

```{r}
results <- lapply(file_years, function(year) {
  run_analysis(year, data_dir = data_dir, output_dir = output_dir, print_tables = TRUE)
})
names(results) <- as.character(file_years)

summary_table <- do.call(rbind, lapply(names(results), function(year) {
  summary_values <- unlist(results[[year]]$summary)
  data.frame(year = as.integer(year), t(summary_values), row.names = NULL)
}))

summary_table
```

# Outputs

CSV tables are saved in `ROutput/` with names such as:

- `Output00_TableAdultStatesPopulation1980.csv`
- `Output01_TableRace1980.csv`
- `Output02_TableRaceHispanic1980.csv`
- `Output03_TableAllHLSpeakersByState1980.csv`
- `Output04_TableHLSpeakersByRegion1980.csv`
- `Output05_TableHLSpeakersByState1980.csv`
- `Output06_TableHLSpeakersByCONSPUMA1980.csv`
- `Output07_TableHLSpeakersByMetro1980.csv`
- `Output08_TableHLSpeakersByEthnicity1980.csv`
- `Output09_TableHLSpeakersByRace1980.csv`
- `Output10_TableHLSpeakersByEducation1980.csv`
- `Output11_TableHLSpeakersByIncome1980.csv`
- `Output12_TableHLSpeakersByAge1980.csv`
- `Output13_TableHLSpeakersByImmigrationGeneration1980.csv`

```{r}
lapply(results, `[[`, "output_paths")
```
