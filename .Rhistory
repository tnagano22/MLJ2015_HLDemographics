knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
file_year <- 1980
data_dir <- "data"
output_dir <- "ROutput"
# Improved analysis workflow for IPUMS heritage language demographics.
suppressPackageStartupMessages({
if (!requireNamespace("foreign", quietly = TRUE)) {
stop("Package 'foreign' is required. Install with install.packages('foreign').")
}
})
read_ipums_spss <- function(file_year, data_dir) {
file_year <- as.character(file_year)
base_name <- paste0("DATA_DOWNLOADED_FROM_IPUMS_SAMPLE", file_year, ".sav")
sav_path <- file.path(data_dir, base_name)
if (!file.exists(sav_path)) {
zip_path <- file.path(data_dir, paste0(base_name, ".zip"))
if (!file.exists(zip_path)) {
stop("Missing input file: ", sav_path, " (or zipped .sav.zip).")
}
tmp_dir <- tempfile("ipums_")
dir.create(tmp_dir)
unzip(zip_path, exdir = tmp_dir)
sav_files <- list.files(tmp_dir, pattern = "\\.sav$", full.names = TRUE)
if (length(sav_files) != 1) {
stop("Expected one .sav file after unzip, found: ", length(sav_files))
}
sav_path <- sav_files[1]
}
data <- foreign::read.spss(sav_path, to.data.frame = TRUE, use.value.labels = TRUE)
droplevels(data)
}
normalize_age <- function(age_factor) {
age_num <- suppressWarnings(as.numeric(as.character(age_factor)))
age_num[is.na(age_num)] <- 0
age_num
}
recode_yrimmig <- function(yrimmig, file_year) {
file_year <- as.character(file_year)
levels_map <- list(
"1980" = c(NA, "1949", "1959", "1964", "1969", "1974", "1980"),
"1990" = c(NA, "1949", "1959", "1964", "1969", "1974", "1979",
"1981", "1984", "1986", "1990"),
"2000" = c("N/A", "1910", "1914", "1919", "1920", "1921", "1922",
"1923", "1924", "1925", "1926", "1927", "1928", "1929",
"1930", "1935", "1936", "1937", "1938", "1939", "1940",
"1941", "1942", "1943", "1944", "1945", "1946", "1947",
"1948", "1949", "1950", "1951", "1952", "1953", "1954",
"1955", "1956", "1957", "1958", "1959", "1960", "1961",
"1962", "1963", "1964", "1965", "1966", "1967", "1968",
"1969", "1970", "1971", "1972", "1973", "1974", "1975",
"1976", "1977", "1978", "1979", "1980", "1981", "1982",
"1983", "1984", "1985", "1986", "1987", "1988", "1989",
"1990", "1991", "1992", "1993", "1994", "1995", "1996",
"1997", "1998", "1999", "2000"),
"2010" = c(NA, "1919", "1920", "1921", "1922", "1923", "1924", "1925",
"1926", "1927", "1928", "1929", "1930", "1932", "1934",
"1935", "1936", "1937", "1938", "1939", "1940", "1941",
"1942", "1943", "1944", "1945", "1946", "1947", "1948",
"1949", "1950", "1951", "1952", "1953", "1954", "1955",
"1956", "1957", "1958", "1959", "1960", "1961", "1962",
"1963", "1964", "1965", "1966", "1967", "1968", "1969",
"1970", "1971", "1972", "1973", "1974", "1975", "1976",
"1977", "1978", "1979", "1980", "1981", "1982", "1983",
"1984", "1985", "1986", "1987", "1988", "1989", "1990",
"1991", "1992", "1993", "1994", "1995", "1996", "1997",
"1998", "1999", "2000", "2001", "2002", "2003", "2004",
"2005", "2006", "2007", "2008", "2009", "2010")
)
new_levels <- levels_map[[file_year]]
if (is.null(new_levels)) {
stop("Unsupported file_year: ", file_year)
}
if (length(levels(yrimmig)) != length(new_levels)) {
warning("Unexpected YRIMMIG levels; using existing labels.")
return(suppressWarnings(as.numeric(as.character(yrimmig))))
}
levels(yrimmig) <- new_levels
suppressWarnings(as.numeric(as.character(yrimmig)))
}
prepare_ipums_data <- function(df, file_year) {
us_states <- c(
"Alabama","Alaska","Arizona","Arkansas","California","Colorado","Connecticut",
"Delaware","District of Columbia","Florida","Georgia","Hawaii","Idaho","Illinois",
"Indiana","Iowa","Kansas","Kentucky","Louisiana","Maine","Maryland","Massachusetts",
"Michigan","Minnesota","Mississippi","Missouri","Montana","Nebraska","Nevada",
"New Hampshire","New Jersey","New Mexico","New York","North Carolina",
"North Dakota","Ohio","Oklahoma","Oregon","Pennsylvania","Rhode Island",
"South Carolina","South Dakota","Tennessee","Texas","Utah","Vermont","Virginia",
"Washington","West Virginia","Wisconsin","Wyoming","American Samoa","Guam",
"Puerto Rico"
)
df$USBorn <- df$BPL %in% us_states
df$AGE_ORIG <- df$AGE
df$AGE <- normalize_age(df$AGE)
df$ADULT <- df$AGE > 18
df$YRIMMIG_ORIG <- df$YRIMMIG
yrimmig_years <- recode_yrimmig(df$YRIMMIG, file_year)
df$YRIMMIG <- as.numeric(file_year) - yrimmig_years
df$IMMIGADULT <- df$YRIMMIG > 18
df$IMMIGADULT[is.na(df$IMMIGADULT)] <- FALSE
df$SPEAKENGWell <- df$SPEAKENG %in% c("Yes, speaks very well", "Yes, speaks well")
df$SPEAKNoENG <- df$SPEAKENG == "Does not speak English"
df$SPEAKHL <- !(df$LANGUAGE %in% c("N/A or blank", "English"))
df
}
compute_hl_tables <- function(df) {
hl_conditions <- df$ADULT & df$SPEAKHL & !df$SPEAKNoENG & !df$IMMIGADULT
hl_order <- rev(order(colSums(xtabs(PERWT ~ STATEFIP + LANGUAGE, data = df[hl_conditions, ]))))
list(
hl_conditions = hl_conditions,
hl_order = hl_order,
adult_population = xtabs(PERWT ~ STATEFIP, data = df),
table_race = xtabs(PERWT ~ RACESING, data = df),
table_hispanic = xtabs(PERWT ~ HISPAN, data = df),
table_all_hl_state = xtabs(PERWT ~ STATEFIP + LANGUAGE, data = df[df$SPEAKHL, ]),
table_hl_region = xtabs(PERWT ~ REGION + LANGUAGE, data = df[hl_conditions, ]),
table_hl_state = xtabs(PERWT ~ STATEFIP + LANGUAGE, data = df[hl_conditions, ]),
table_hl_conspuma = xtabs(PERWT ~ CONSPUMA + LANGUAGE, data = df[hl_conditions, ]),
table_hl_metro = xtabs(PERWT ~ METRO + LANGUAGE, data = df[hl_conditions, ])
)
}
write_hl_outputs <- function(tables, file_year, output_dir) {
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
file_year <- as.character(file_year)
order_lang_cols <- function(tbl, hl_order) {
if (is.null(dim(tbl))) {
return(tbl)
}
tbl[, hl_order, drop = FALSE]
}
output_paths <- list(
adult_states = file.path(output_dir, paste0("Output00_TableAdultStatesPopulation", file_year, ".csv")),
race = file.path(output_dir, paste0("Output01_TableRace", file_year, ".csv")),
hispanic = file.path(output_dir, paste0("Output02_TableRaceHispanic", file_year, ".csv")),
all_hl_state = file.path(output_dir, paste0("Output03_TableAllHLSpeakersByState", file_year, ".csv")),
hl_region = file.path(output_dir, paste0("Output04_TableHLSpeakersByRegion", file_year, ".csv")),
hl_state = file.path(output_dir, paste0("Output05_TableHLSpeakersByState", file_year, ".csv")),
hl_conspuma = file.path(output_dir, paste0("Output06_TableHLSpeakersByCONSPUMA", file_year, ".csv")),
hl_metro = file.path(output_dir, paste0("Output07_TableHLSpeakersByMetro", file_year, ".csv"))
)
write.csv(tables$adult_population, file = output_paths$adult_states)
write.csv(tables$table_race, file = output_paths$race)
write.csv(tables$table_hispanic, file = output_paths$hispanic)
write.csv(order_lang_cols(tables$table_all_hl_state, tables$hl_order), file = output_paths$all_hl_state)
write.csv(order_lang_cols(tables$table_hl_region, tables$hl_order), file = output_paths$hl_region)
write.csv(order_lang_cols(tables$table_hl_state, tables$hl_order), file = output_paths$hl_state)
write.csv(order_lang_cols(tables$table_hl_conspuma, tables$hl_order), file = output_paths$hl_conspuma)
write.csv(order_lang_cols(tables$table_hl_metro, tables$hl_order), file = output_paths$hl_metro)
output_paths
}
run_analysis <- function(file_year, data_dir = "data", output_dir = "ROutput") {
df <- read_ipums_spss(file_year, data_dir)
df <- prepare_ipums_data(df, file_year)
tables <- compute_hl_tables(df)
output_paths <- write_hl_outputs(tables, file_year, output_dir)
summary <- list(
total_population = sum(df$PERWT),
total_speak_hl = sum(df[df$SPEAKHL, "PERWT"]),
total_hl = sum(df[tables$hl_conditions, "PERWT"]),
share_foreign_born = sum(df[!df$USBorn, "PERWT"]) / sum(df$PERWT)
)
list(summary = summary, output_paths = output_paths, tables = tables)
}
results <- run_analysis(file_year, data_dir = data_dir, output_dir = output_dir)
results$summary
results$output_paths
